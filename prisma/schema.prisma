generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// =========================
/// Enums
/// =========================
enum OrganizationType {
  COLLEGE
  BANQUE
  UNIVERSITE
  LYCEE
  ENTREPRISE
  TRADUCTEUR
}

enum UserProfileType {
  ADMIN
  SUPER_ADMIN
  DEMANDEUR
  INSTITUT
  TRADUCTEUR
  SUPERVISEUR
}

enum PaymentType {
  MOBILE_MONEY
  BANK_TRANSFER
  CARD
  STRIPE
  PAYPAL
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELED
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELED
}

enum PaymentStatus {
  INITIATED
  REQUIRES_ACTION
  AUTHORIZED
  CAPTURED
  CANCELED
  FAILED
  SUCCEEDED
}
enum GenderType {
  MALE
  FEMALE
  OTHER
}

/// =========================
/// Identité & appartenance
/// =========================
model User {
  id               String           @id @default(cuid())
  username         String           @unique
  email            String           @unique
  passwordHash     String
  avatar           String?
  firstName         String?
  lastName         String?
  enabled          Boolean          @default(true)
  adress           String?
  phone            String?
  dateOfBirth      DateTime?
  placeOfBirth     String? 
  profession       String?
  gender           GenderType       @default(MALE)
  country          String?

    /// Profil exclusif
  role             UserProfileType  @default(DEMANDEUR)

  /// 0/1 appartenance à une société
  organizationId   String?         
  organization     Organization?    @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  /// Permissions globales
  permissions      Permission[]     @relation("UsersPermissions")

  /// Métier
  demandes         DemandePartage[]      // OK: backref via DemandePartage.user
  transactions     Transaction[]         // OK: backref via Transaction.user

  /// Reset inline (facultatif)
  tokenActiveted   String?
  hashedToken      String?
  requestedAt      DateTime?
  expiresAt        DateTime?

  resetToken       String?
  resetTokenExpiry DateTime?
  

  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  deletedAt        DateTime?

  auditLogs       AuditLog[]

  @@index([organizationId])
  @@index([role])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  resource   String
  resourceId String?
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}


model Organization {
  id               String               @id @default(cuid())
  name             String
  slug             String              @unique
  type             OrganizationType
  email            String?
  phone            String?
  address          String?
  website          String?
  country          String?

  users            User[]

  departments      Department[]
  subscriptions    Abonnement[]

  // Relations nommées pour éviter toute ambiguïté
  shareRequests    DemandePartage[]    @relation("OrgTargetFiles")     // cible (targetOrg)
  sharedDocuments  DocumentPartage[]   // ownerOrg (unique relation, pas besoin de nom)
  assignedFiles    DemandePartage[]    @relation("OrgAssignedFiles")

  outgoingInvites  OrganizationInvite[] @relation("OrgInviter")
  incomingInvites  OrganizationInvite[] @relation("OrgInvitee")

  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  deletedAt        DateTime?

  @@index([type])
}


/// =========================
/// Permissions (sans Role)
/// =========================
model Permission {
  id            String        @id @default(cuid())
  key           String        @unique  // ex: "demande.read"
  name          String
  description   String?
  users         User[]        @relation("UsersPermissions")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  @@index([name])
}



model DemandePartage {
  id                   String        @id @default(cuid())
  targetOrgId          String
  assignedOrgId        String?
  userId               String?
  code                 String?       @unique
  dateDemande          DateTime      @default(now())
  isDeleted            Boolean       @default(false)

  // --- Métadonnées académiques existantes ---
  serie                String?
  niveau               String?
  mention              String?
  annee                String?
  countryOfSchool      String?
  secondarySchoolName  String?
  graduationDate       DateTime?

  // Champs “header/dossier”
  periode              String?
  year                 String?
  status               String?
  observation          String?

  // Paiement
  payment              Payment?
  statusPayment        String?

  // Identité personnelle
  dob                  DateTime?
  citizenship          String?
  passport             String?

  // Anglais / Tests
  isEnglishFirstLanguage Boolean?
  englishProficiencyTests Json?
  testScores           String?

  // Scolarité / Notes
  gradingScale         String?
  gpa                  String?
  examsTaken           Json?
  intendedMajor        String?

  // Activités / Distinctions
  extracurricularActivities String?
  honorsOrAwards       String?

  // Famille
  parentGuardianName   String?
  occupation           String?
  educationLevel       String?

  // Financier
  willApplyForFinancialAid Boolean?
  hasExternalSponsorship   Boolean?

  // Visa
  visaType             String?
  hasPreviouslyStudiedInUS Boolean?

  // Essays
  personalStatement    String?
  optionalEssay        String?

  // Candidature
  applicationRound     String?
  howDidYouHearAboutUs String?

  // Relations
  user                 User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  targetOrg            Organization   @relation("OrgTargetFiles", fields: [targetOrgId], references: [id], onDelete: Restrict)
  assignedOrg          Organization?  @relation("OrgAssignedFiles", fields: [assignedOrgId], references: [id], onDelete: SetNull)

  documents            DocumentPartage[]
  transaction          Transaction?

  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  deletedAt            DateTime?

  @@index([userId])
  @@index([targetOrgId])
  @@index([assignedOrgId])
  @@index([dateDemande])
  @@index([code])
}





model DocumentPartage {
  id               String         @id @default(cuid())
  demandePartageId String
  ownerOrgId       String
  urlOriginal      String?
  type             String?
  mention          String?
  dateObtention    String?
  urlChiffre       String?
  urlTraduit       String?
  encryptionKey    String?
  encryptionKeyTraduit String?
  estTraduit       Boolean        @default(false)
  aDocument        Boolean        @default(true)

  demandePartage   DemandePartage @relation(fields: [demandePartageId], references: [id], onDelete: Cascade)
  ownerOrg         Organization   @relation(fields: [ownerOrgId], references: [id], onDelete: Restrict)

  encryptionIV    String?    // Ajout du vecteur d'initialisation
  blockchainHash  String?    // Empreinte blockchain
  encryptedBy     String?    // ID de l'utilisateur qui a chiffré
  encryptedAt     DateTime?

  // TRADUCTION (sur le même document)
  urlChiffreTraduit    String?
  encryptionIVTraduit  String?
  blockchainHashTraduit String?
  encryptedByTraduit   String?
  encryptedAtTraduit   DateTime?

  
  // Relation avec les blocs blockchain (optionnel)
  blockchainBlocks BlockchainBlock[]

  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  deletedAt        DateTime?

  @@index([ownerOrgId])
  @@index([estTraduit])
}

model BlockchainBlock {
  
  id            String   @id @default(cuid())
  index         Int?
  timestamp     DateTime?
  transactions  String?   // JSON des transactions
  previousHash  String?
  hash          String?   @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now())

  document      DocumentPartage? @relation(fields: [documentId], references: [id])
  documentId    String?


  @@map("blokchaineblcks")
}


model Abonnement {
  id               String        @id @default(cuid())
  organizationId   String
  dateDebut        DateTime
  dateExpiration   DateTime
  montant          Decimal        @db.Decimal(12,2)
  isDeleted        Boolean        @default(false)

  organization     Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  payments         Payment[]

  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  deletedAt        DateTime?

  @@index([organizationId])
  @@index([dateExpiration])
}

model Transaction {
  id               String            @id @default(cuid())
  demandePartageId String            @unique
  userId      String?
  montant          Decimal           @db.Decimal(12,2)
  dateTransaction  DateTime          @default(now())
  typePaiement     PaymentType
  typeTransaction  String?
  statut           TransactionStatus @default(PENDING)
  isDeleted        Boolean           @default(false)

  demandePartage   DemandePartage    @relation(fields: [demandePartageId], references: [id], onDelete: Cascade)
  user             User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  payment          Payment?

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  deletedAt        DateTime?

  @@index([dateTransaction])
  @@index([statut])
}

model ContactMessage {
  id               String     @id @default(cuid())
  name             String
  email            String
  subject          String?
  message          String?
  status      ContactStatus @default(PENDING)
  response    String?
  respondedAt DateTime?
  respondedBy String?
  
  createdAt        DateTime   @default(now())
  @@index([email])
}

enum ContactStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
  CLOSED
}

model Configuration {
  id               String     @id @default(cuid())
  key              String     @unique
  value            String?

  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
}

model SiteSettings {
  id           String   @id @default(cuid())
  siteName     String   @default("APPLYONS")
  logo         String?
  favicon      String?
  contactEmail String?
  contactAddress String?
  contactPhone String?
  contactMobile String?
  urlSite       String?
  socialMedia  Json?
  footer       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("site_settings")
}


/// =========================
/// Éducation : Département & Filière
/// =========================
model Department {
  id               String         @id @default(cuid())
  organizationId   String
  name             String
  code             String?
  description      String?

  organization     Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  filieres         Filiere[]

  @@unique([organizationId, name])
  @@index([organizationId])
}

model Filiere {
  id               String       @id @default(cuid())
  departmentId     String
  name             String
  code             String?
  description      String?
  level            String?

  department       Department   @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@unique([departmentId, name])
  @@index([departmentId])
}

/// =========================
/// Invitations d’organisation
/// =========================
model OrganizationInvite {
  id               String          @id @default(cuid())
  inviterOrgId     String
  inviteeOrgId     String?
  inviteeName      String?
  inviteeEmail     String
  inviteePhone     String?
  inviteeAddress   String?
  token            String          @unique
  status           InviteStatus    @default(PENDING)
  roleKey          String?         // rôle string proposé
  expiresAt        DateTime?
  acceptedAt       DateTime?

  inviterOrg       Organization    @relation("OrgInviter", fields: [inviterOrgId], references: [id], onDelete: Cascade)
  inviteeOrg       Organization?   @relation("OrgInvitee", fields: [inviteeOrgId], references: [id], onDelete: SetNull)

  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([inviteeEmail])
  @@index([status])
}

/// =========================
/// Paiements & Reset
/// =========================
model Payment {
  id               String         @id @default(cuid())

  transactionId    String?        @unique
  demandePartageId String?        @unique
  abonnementId     String?

  provider         String
  providerRef      String?
  status           PaymentStatus    @default(INITIATED)
  amount           Decimal          @db.Decimal(12,2)
  currency         String
  paymentType      PaymentType
  paymentInfo      Json?

  transaction      Transaction?     @relation(fields: [transactionId], references: [id], onDelete: SetNull)
  demandePartage   DemandePartage?  @relation(fields: [demandePartageId], references: [id], onDelete: SetNull)
  abonnement       Abonnement?      @relation(fields: [abonnementId], references: [id], onDelete: SetNull)

  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([provider, providerRef])
  @@index([status])
}

/// =========================
/// Notifications (ex: ajout/traduction de documents)
/// =========================
model Notification {
  id                 String          @id @default(cuid())
  userId             String
  demandePartageId   String?
  documentPartageId  String?
  type               String          // ex: "DOC_ADDED", "DOC_TRANSLATED"
  title              String
  message            String
  readAt             DateTime?
  createdAt          DateTime        @default(now())

  user               User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  demandePartage     DemandePartage? @relation(fields: [demandePartageId], references: [id])
  documentPartage    DocumentPartage? @relation(fields: [documentPartageId], references: [id])

  @@index([userId, createdAt])
  @@index([demandePartageId])
  @@index([documentPartageId])
}

